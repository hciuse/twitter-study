---
title: "COVID-19 Infection Comparison: Vaccinated vs. Unvaccinated vs. Total Sample"
author: "LST"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: flatly
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width=10, fig.height=6)
library(dplyr)
library(ggplot2)
library(knitr)
library(here)
library(tidyr)
```

## Introduction

This report compares COVID-19 infection frequencies between vaccinated individuals, unvaccinated individuals, and the total sample (including participants with missing vaccination status).

## Data Preparation

```{r data-preparation}
# Load and prepare data
cleaned_data <- readRDS(file = here("data", "cleaned_data.rds"))

# Create English mapping for infection frequencies
cleaned_data <- cleaned_data %>%
  mutate(
    num_c19_infs_eng = case_when(
      num_c19_infs == "Nie" ~ "0",
      num_c19_infs == "Einmal" ~ "1",
      num_c19_infs == "Zweimal" ~ "2+",
      num_c19_infs == "Dreimal" ~ "2+",
      num_c19_infs == "Mehr als dreimal" ~ "2+",
      num_c19_infs == "Ich möchte nicht antworten" ~ "I Don't Want To Answer",
      TRUE ~ NA_character_
    )
  )

# Filter groups
unvacc <- cleaned_data %>% filter(c19_vaccination_status == "Nein")
vacc <- cleaned_data %>% filter(c19_vaccination_status == "Ja")
total_sample <- cleaned_data %>% filter(!is.na(num_c19_infs))

# Sample sizes
n_unvacc <- nrow(unvacc)
n_vacc <- nrow(vacc)
n_total <- 867  # Total sample size as specified
n_na_vacc_status <- n_total - n_unvacc - n_vacc
```

**Sample Sizes:**

- Total sample: `r n_total`
- Vaccinated: `r n_vacc` (`r round(n_vacc/n_total * 100, 2)`%)
- Unvaccinated: `r n_unvacc` (`r round(n_unvacc/n_total * 100, 2)`%)
- Missing vaccination status: `r n_na_vacc_status` (`r round(n_na_vacc_status/n_total * 100, 2)`%)

## Comparison of Infection Frequencies

```{r comparison-plot}
# Calculate percentages for all three groups using the English mapping
unvacc_counts <- table(unvacc$num_c19_infs_eng)
unvacc_pct <- prop.table(unvacc_counts) * 100

vacc_counts <- table(vacc$num_c19_infs_eng)
vacc_pct <- prop.table(vacc_counts) * 100

total_counts <- table(total_sample$num_c19_infs_eng)
total_pct <- prop.table(total_counts) * 100

# Define infection categories in English
infection_categories_eng <- c("0", "1", "2+", "I Don't Want To Answer")

# Create comparison data frame
comparison_df <- data.frame(
  Category = infection_categories_eng,
  Unvaccinated = sapply(infection_categories_eng, function(x) {
    ifelse(x %in% names(unvacc_pct), unvacc_pct[x], 0)
  }),
  Vaccinated = sapply(infection_categories_eng, function(x) {
    ifelse(x %in% names(vacc_pct), vacc_pct[x], 0)
  }),
  Total_Sample = sapply(infection_categories_eng, function(x) {
    ifelse(x %in% names(total_pct), total_pct[x], 0)
  })
)

# Reshape for plotting
comparison_long <- comparison_df %>%
  pivot_longer(cols = c(Unvaccinated, Vaccinated, Total_Sample), 
               names_to = "Group", 
               values_to = "Percentage") %>%
  mutate(Group = recode(Group, Total_Sample = "Total Sample"))

# Set factor order for categories
comparison_long$Category <- factor(comparison_long$Category, levels = infection_categories_eng)
comparison_long$Group <- factor(comparison_long$Group, levels = c("Unvaccinated", "Vaccinated", "Total Sample"))

# Create grouped bar plot
ggplot(comparison_long, aes(x = Category, y = Percentage, fill = Group)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  scale_fill_manual(values = c("Unvaccinated" = "#E74C3C", 
                                "Vaccinated" = "#3498DB", 
                                "Total Sample" = "#95A5A6")) +
  labs(title = "COVID-19 Infection Frequency: Unvaccinated vs. Vaccinated vs. Total Sample",
       x = "Infection Frequency",
       y = "Percentage (%)",
       fill = "Group") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        legend.position = "top") +
  geom_text(aes(label = sprintf("%.1f%%", Percentage)), 
            position = position_dodge(width = 0.7), 
            vjust = -0.5, size = 2.5)
```

## Reweighting Analysis: 13% Unvaccinated Scenario

```{r reweighting-calculation}
# Define target proportions based on total sample of 867
target_unvacc_prop <- 0.13
target_vacc_prop <- 0.87  # Assuming NA participants would follow vaccinated distribution

# Current proportions
current_unvacc_prop <- n_unvacc / n_total
current_vacc_prop <- (n_vacc + n_na_vacc_status) / n_total

# Hypothetical sample sizes for 13% unvaccinated scenario
hypothetical_n_unvacc <- round(n_total * target_unvacc_prop)
hypothetical_n_vacc <- n_total - hypothetical_n_unvacc

# Define infection categories in German (for actual counting)
infection_categories <- c("Nie", "Einmal", "Zweimal", "Dreimal", 
                          "Mehr als dreimal", "Ich möchte nicht antworten")

# Calculate actual counts for each infection frequency category
actual_counts_unvacc <- sapply(infection_categories, function(x) {
  sum(unvacc$num_c19_infs == x, na.rm = TRUE)
})

actual_counts_vacc_and_na <- sapply(infection_categories, function(x) {
  sum(total_sample$num_c19_infs == x & 
      (total_sample$c19_vaccination_status == "Ja" | 
       is.na(total_sample$c19_vaccination_status)), na.rm = TRUE)
})

# Calculate proportions within each group
prop_unvacc <- actual_counts_unvacc / n_unvacc
prop_vacc_and_na <- actual_counts_vacc_and_na / (n_vacc + n_na_vacc_status)

# Apply these proportions to hypothetical sample sizes
expected_counts_unvacc <- hypothetical_n_unvacc * prop_unvacc
expected_counts_vacc <- hypothetical_n_vacc * prop_vacc_and_na

# Calculate total counts for actual and reweighted scenarios
actual_total_counts <- sapply(infection_categories, function(x) {
  sum(total_sample$num_c19_infs == x, na.rm = TRUE)
})
expected_total_counts <- expected_counts_unvacc + expected_counts_vacc
```

### Sample Composition Comparison

```{r sample-composition-plot}
# Create sample composition data
composition_data <- data.frame(
  Scenario = rep(c("Actual Sample", "Reweighted (13% Unvacc)"), each = 2),
  Group = rep(c("Unvaccinated", "Vaccinated + NA"), 2),
  Count = c(n_unvacc, n_vacc + n_na_vacc_status, 
            hypothetical_n_unvacc, hypothetical_n_vacc),
  Percentage = c(current_unvacc_prop * 100, current_vacc_prop * 100,
                 target_unvacc_prop * 100, target_vacc_prop * 100)
)

composition_data$Scenario <- factor(composition_data$Scenario, 
                                    levels = c("Actual Sample", "Reweighted (13% Unvacc)"))

ggplot(composition_data, aes(x = Scenario, y = Percentage, fill = Group)) +
  geom_bar(stat = "identity", width = 0.6) +
  scale_fill_manual(values = c("Unvaccinated" = "#E74C3C", 
                                "Vaccinated + NA" = "#3498DB")) +
  labs(title = "Sample Composition: Actual vs. Reweighted (Total N=867)",
       x = NULL,
       y = "Percentage (%)",
       fill = "Group") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        legend.position = "top") +
  geom_text(aes(label = sprintf("%.1f%%\n(n=%d)", Percentage, Count)), 
            position = position_stack(vjust = 0.5), 
            color = "white", size = 4, fontface = "bold")
```

### Total Infection Percentage Comparison

```{r total-percentage-comparison-plot}
# Map German categories to English for display
category_mapping <- data.frame(
  German = infection_categories,
  English = c("Never", "Once", "Twice", "Three times", 
              "More than three times", "Prefer not to answer")
)

# Create comparison data for actual vs expected (as percentages)
reweight_comparison <- data.frame(
  Category_DE = infection_categories,
  Actual_Count = actual_total_counts,
  Expected_Count = expected_total_counts,
  Actual_Pct = (actual_total_counts / n_total) * 100,
  Expected_Pct = (expected_total_counts / n_total) * 100
) %>%
  left_join(category_mapping, by = c("Category_DE" = "German")) %>%
  rename(Category = English)

reweight_comparison$Change_Pct <- reweight_comparison$Expected_Pct - reweight_comparison$Actual_Pct
reweight_comparison$Category <- factor(reweight_comparison$Category, 
                                       levels = c("Never", "Once", "Twice", "Three times", 
                                                  "More than three times", "Prefer not to answer"))

# Reshape for plotting
reweight_long <- reweight_comparison %>%
  select(Category, Actual_Pct, Expected_Pct) %>%
  pivot_longer(cols = c(Actual_Pct, Expected_Pct), 
               names_to = "Scenario", 
               values_to = "Percentage") %>%
  mutate(Scenario = recode(Scenario, 
                           Actual_Pct = "Actual", 
                           Expected_Pct = "Reweighted (13% Unvacc)"))

ggplot(reweight_long, aes(x = Category, y = Percentage, fill = Scenario)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7) +
  scale_fill_manual(values = c("Actual" = "#95A5A6", 
                                "Reweighted (13% Unvacc)" = "#E67E22")) +
  labs(title = "Total Infection Percentages: Actual vs. Reweighted to 13% Unvaccinated (N=867)",
       x = "Infection Frequency",
       y = "Percentage of Total Sample (%)",
       fill = "Scenario") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
        legend.position = "top") +
  geom_text(aes(label = sprintf("%.1f%%", Percentage)), 
            position = position_dodge(width = 0.7), 
            vjust = -0.5, size = 3)
```

## Summary Statistics

```{r summary-table}
# Calculate counts for total sample
actual_counts_total <- sapply(infection_categories, function(x) {
  sum(total_sample$num_c19_infs == x, na.rm = TRUE)
})

actual_counts_vacc <- sapply(infection_categories, function(x) {
  sum(vacc$num_c19_infs == x, na.rm = TRUE)
})

# Calculate proportions
prop_unvacc <- actual_counts_unvacc / n_unvacc
prop_vacc <- actual_counts_vacc / n_vacc
prop_total <- actual_counts_total / n_total

# Create summary table with both German and English categories
summary_table <- data.frame(
  Category_DE = infection_categories,
  Category_EN = c("Never", "Once", "Twice", "Three times", 
                  "More than three times", "Prefer not to answer"),
  Unvaccinated_N = actual_counts_unvacc,
  Unvaccinated_Pct = round(prop_unvacc * 100, 2),
  Vaccinated_N = actual_counts_vacc,
  Vaccinated_Pct = round(prop_vacc * 100, 2),
  Total_N = actual_counts_total,
  Total_Pct = round(prop_total * 100, 2)
)

kable(summary_table, 
      col.names = c("Category (DE)", "Category (EN)", 
                    "N", "%", "N", "%", "N", "%"),
      caption = "COVID-19 Infection Frequencies by Vaccination Status and Total Sample",
      align = c("l", "l", "r", "r", "r", "r", "r", "r"))
```

## Reweighting Details

```{r reweighting-details-table}
reweight_detail <- data.frame(
  Category = reweight_comparison$Category,
  Actual_N = round(reweight_comparison$Actual_Count, 0),
  Actual_Pct = round(reweight_comparison$Actual_Pct, 2),
  Expected_N = round(reweight_comparison$Expected_Count, 0),
  Expected_Pct = round(reweight_comparison$Expected_Pct, 2),
  Change_Pct = round(reweight_comparison$Change_Pct, 2)
)

kable(reweight_detail,
      col.names = c("Infection Frequency", "N", "%", "N", "%", "Change (%)"),
      caption = "Reweighting Impact: Actual vs. Expected (13% Unvaccinated) in Total Sample (N=867)",
      align = c("l", "r", "r", "r", "r", "r"))
```